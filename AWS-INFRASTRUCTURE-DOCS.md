# AWS Infrastructure Documentation

## CloudFormation Stack Overview

**Stack Name**: `better-call-saul-infrastructure`
**Region**: `us-east-1`
**Environment**: `production`

## Architecture Components

### Frontend Infrastructure
- **S3 Bucket**: `better-call-saul-frontend-production`
  - Hosts static React application files
  - Private access with CloudFront OAI
- **CloudFront Distribution**: `d1c0215ar7cs56.cloudfront.net`
  - Global CDN for fast content delivery
  - HTTPS redirect enabled
  - Custom error pages for SPA routing

### Backend Infrastructure
- **ECS Cluster**: `bettercallsaul-cluster-production`
  - Fargate launch type (serverless containers)
  - 256 CPU units, 512 MB memory
- **ECR Repository**: `946591677346.dkr.ecr.us-east-1.amazonaws.com/bettercallsaul-api`
- **Application Load Balancer**: `bettercallsaul-alb-production-518268597.us-east-1.elb.amazonaws.com`
  - Health check endpoint: `/health`
  - HTTP only (port 80)

### Database Infrastructure

#### PostgreSQL (Primary Database)
- **Instance**: `bettercallsaul-db-production.c3tabpdofwvl.us-east-1.rds.amazonaws.com`
- **Engine**: PostgreSQL 15.7
- **Instance Class**: db.t3.micro
- **Database Name**: `BetterCallSaul`
- **Username**: `bettercallsaul`
- **Port**: 5432
- **Storage**: 20GB GP2, encrypted
- **Backup Retention**: 7 days
- **Location**: Private subnets (not publicly accessible)

#### DocumentDB (NoSQL Database)
- **Cluster**: `bettercallsaul-docdb-production.cluster-c3tabpdofwvl.us-east-1.docdb.amazonaws.com`
- **Instance Class**: db.t3.medium
- **Username**: `bettercallsaul`
- **Port**: 27017
- **Encryption**: Enabled
- **Backup Retention**: 7 days
- **Location**: Private subnets (not publicly accessible)

### Networking
- **VPC CIDR**: 10.0.0.0/16
- **Public Subnets**:
  - 10.0.1.0/24 (AZ-1)
  - 10.0.2.0/24 (AZ-2)
- **Private Subnets**:
  - 10.0.3.0/24 (AZ-1)
  - 10.0.4.0/24 (AZ-2)

### Security Groups
- **ALB Security Group**: Allows HTTP (80) and HTTPS (443) from internet
- **ECS Security Group**: Allows HTTP (80) from ALB only
- **Database Security Group**: Allows PostgreSQL (5432) from ECS only
- **DocumentDB Security Group**: Allows MongoDB (27017) from ECS only

### IAM Roles
- **ECS Execution Role**: Standard ECS task execution permissions
- **ECS Task Role**: Custom permissions for:
  - AWS Bedrock AI services
  - S3 bucket access
  - AWS Textract document processing

## Database Connection Methods

### Method 1: Via ECS Task (Recommended)
```bash
# Get running task
aws ecs list-tasks --cluster bettercallsaul-cluster-production

# Execute command in running container
aws ecs execute-command \
    --cluster bettercallsaul-cluster-production \
    --task <task-arn> \
    --container bettercallsaul-api \
    --interactive \
    --command "/bin/bash"
```

### Method 2: Direct Connection (Requires VPN/Bastion)
**PostgreSQL:**
```bash
psql -h bettercallsaul-db-production.c3tabpdofwvl.us-east-1.rds.amazonaws.com \
     -p 5432 -U bettercallsaul -d BetterCallSaul
```

**DocumentDB:**
```bash
mongo --ssl \
      --host bettercallsaul-docdb-production.cluster-c3tabpdofwvl.us-east-1.docdb.amazonaws.com:27017 \
      --username bettercallsaul
```

### Method 3: Application Connection Strings
**PostgreSQL (.NET):**
```
Server=bettercallsaul-db-production.c3tabpdofwvl.us-east-1.rds.amazonaws.com;Database=BetterCallSaul;Username=bettercallsaul;Password=${RDS_PASSWORD};Port=5432;
```

**DocumentDB (MongoDB):**
```
mongodb://bettercallsaul:${RDS_PASSWORD}@bettercallsaul-docdb-production.cluster-c3tabpdofwvl.us-east-1.docdb.amazonaws.com:27017/?ssl=true&replicaSet=rs0&readPreference=secondaryPreferred&retryWrites=false
```

## Environment Variables in ECS

The application container receives these environment variables:
- `ASPNETCORE_ENVIRONMENT=production`
- `AWS_REGION=us-east-1`
- `RDS_HOST=bettercallsaul-db-production.c3tabpdofwvl.us-east-1.rds.amazonaws.com`
- `RDS_USERNAME=bettercallsaul`
- `RDS_PASSWORD=<auto-generated>`
- `DOCUMENTDB_CONNECTION_STRING=<full-connection-string>`
- `JWT_SECRET_KEY=<auto-generated>`

## Deployment Commands

### Deploy Infrastructure
```bash
cd .aws
./deploy-infrastructure.sh
```

### View Stack Outputs
```bash
aws cloudformation describe-stacks \
    --stack-name better-call-saul-infrastructure \
    --query 'Stacks[0].Outputs' \
    --output table
```

### Update Stack
```bash
aws cloudformation update-stack \
    --stack-name better-call-saul-infrastructure \
    --template-body file://cloudformation-stack.yml \
    --capabilities CAPABILITY_NAMED_IAM
```

## Monitoring and Logs

### CloudWatch Log Groups
- **ECS Logs**: `/ecs/bettercallsaul-api-production`
- **Retention**: 30 days

### View Application Logs
```bash
aws logs tail /ecs/bettercallsaul-api-production --follow
```

### View ECS Service Status
```bash
aws ecs describe-services \
    --cluster bettercallsaul-cluster-production \
    --services bettercallsaul-api
```

## Cost Optimization Notes

- **Database**: Using db.t3.micro for PostgreSQL (lowest cost tier)
- **DocumentDB**: Using db.t3.medium (minimum size for DocumentDB)
- **ECS**: Fargate with minimal CPU/memory allocation
- **Storage**: GP2 storage with 20GB minimum
- **Deletion Protection**: Enabled on databases to prevent accidental deletion

## Security Notes

- All databases are in private subnets (no internet access)
- Security groups restrict access to application layer only
- Database passwords are auto-generated and complex
- Storage encryption enabled for all databases
- CloudFront enforces HTTPS for frontend
- IAM roles follow least privilege principle

## Backup and Recovery

- **RDS**: Automated backups with 7-day retention
- **DocumentDB**: Automated backups with 7-day retention
- **Deletion Policy**: Snapshot on stack deletion
- **Multi-AZ**: Disabled to reduce costs (consider enabling for production)

## Next Steps for Production

1. **Enable Multi-AZ** for RDS for high availability
2. **Setup Route 53** for custom domain
3. **Configure SSL/TLS** certificates via ACM
4. **Setup monitoring** with CloudWatch alarms
5. **Configure backup retention** based on requirements
6. **Setup VPC endpoints** for better security
7. **Enable AWS Config** for compliance monitoring

## Troubleshooting

### Application Not Starting
1. Check ECS service events
2. Review CloudWatch logs
3. Verify environment variables
4. Test database connectivity

### Database Connection Issues
1. Verify security group rules
2. Check subnet routing
3. Validate credentials
4. Test from ECS task

### Frontend Not Loading
1. Check CloudFront distribution status
2. Verify S3 bucket contents
3. Review origin access identity configuration